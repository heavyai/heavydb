

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.6. Query Results &mdash; OmniSciDB  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.webp"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/segment_analytics.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Glossary of Terms" href="../glossary/index.html" />
    <link rel="prev" title="7.5. Execution Kernels" href="kernels.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OmniSciDB
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">System Architecture</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">1. OmniSciDB at 30,000 Feet</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#high-level-diagram">1.1. High Level Diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#data-model">1.2. Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#data-flow">1.3. Data Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#query-execution">1.4. Query Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#simple-execution-model">1.5. Simple Execution Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/getting_started.html">2. Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/deps.html">2.1. Server Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#prebuilt-dependencies">2.1.1. Prebuilt Dependencies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/deps.html#environment-variables">2.1.1.1. Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-ubuntu">2.1.2. Building on Ubuntu</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/deps.html#ubuntu-16-04">2.1.2.1. Ubuntu 16.04</a></li>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/deps.html#ubuntu-18-04">2.1.2.2. Ubuntu 18.04</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-centos">2.1.3. Building on CentOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-macos">2.1.4. Building on macOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-arch-linux">2.1.5. Building on Arch Linux</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/build.html">2.2. Build OmniSciDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/start.html">2.3. Start and Load Sample Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/start.html#starting-the-server">2.3.1. Starting the Server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/start.html#starting-manually">2.3.1.1. Starting Manually</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/start.html#working-with-data">2.3.2. Working With Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../catalog/index.html">3. Catalog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#high-level-overview">3.1. High Level Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#system-catalog-global">3.2. System Catalog (Global)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#users">3.2.1. Users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#roles">3.2.2. Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#databases">3.2.3. Databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#permissions">3.2.4. Permissions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#catalog-database-specific">3.3. Catalog (Database Specific)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#tables">3.3.1. Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#columns">3.3.2. Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#dictionaries">3.3.3. Dictionaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#sharded-tables">3.3.4. Sharded Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#views">3.3.5. Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#dashboards">3.3.6. Dashboards</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#migration">3.4. Migration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data_model/index.html">4. Data Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../data_model/columnar_layout.html">4.1. Columnar Data Organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/columnar_layout.html#columns">4.1.1. Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/columnar_layout.html#fragments">4.1.2. Fragments</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/columnar_layout.html#chunks">4.1.3. Chunks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../data_model/columnar_layout.html#example-for-chunk-physical-representations">4.1.3.1. Example for chunk physical representations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../data_model/columnar_layout.html#chunkkey">4.1.3.2. ChunkKey</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/physical_layout.html">4.2. Physical Data Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/physical_layout.html#directory-structure">4.2.1. Directory Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../data_model/physical_layout.html#epoch">4.2.1.1. Epoch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/physical_layout.html#data-multipages">4.2.2. Data Multipages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../data_model/physical_layout.html#example-data-page">4.2.2.1. Example Data Page:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/physical_layout.html#metadata-pages">4.2.3. Metadata Pages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/memory_layout.html">4.3. Memory  Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/api.html">4.4. External API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/api.html#design">4.4.1. Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/api.html#protocols">4.4.2. Protocols</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/types.html">4.5. Data Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/types.html#scalar-types">4.5.1. Scalar Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/types.html#scalar-types-with-encoding">4.5.2. Scalar Types with Encoding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/types.html#variable-length-types">4.5.3. Variable Length Types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../flow/data.html">5. Data Flow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../flow/data.html#input-data">5.1. Input Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flow/data.html#output-data">5.2. Output Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../calcite/calcite_parser.html">6. Calcite Parser</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. Query Execution</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">7.1. Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="overview.html#request-handler-mapdhandler">7.1.1. Request Handler (MapDHandler)</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#apache-calcite">7.1.2. Apache Calcite</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#relational-algebra-executor">7.1.3. Relational Algebra Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#relational-algebra-abstract-interpreter-and-optimizer">7.1.4. Relational Algebra Abstract Interpreter and Optimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#relational-algebra-translator">7.1.5. Relational Algebra Translator</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#executor">7.1.6. Executor</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="optimizer.html">7.2. Interpreter / Optimizer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="optimizer.html#interpreter">7.2.1. Interpreter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#relalgnode">7.2.1.1. <code class="docutils literal notranslate"><span class="pre">RelAlgNode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#rex">7.2.1.2. <code class="docutils literal notranslate"><span class="pre">Rex</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="optimizer.html#omniscidb-specific-query-optimization">7.2.2. OmniSciDB Specific Query Optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#mark-noops">7.2.2.1. Mark Noops</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#eliminate-identical-copies">7.2.2.2. Eliminate Identical Copies</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#fold-filters">7.2.2.3. Fold Filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#eliminate-dead-columns">7.2.2.4. Eliminate Dead Columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#separate-window-function-expressions">7.2.2.5. Separate Window Function Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#coalesce-nodes">7.2.2.6. Coalesce Nodes</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#create-left-deep-join">7.2.2.7. Create Left Deep Join</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="scheduler.html">7.3. DAG Execution / Translation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#determining-execution-order">7.3.1. Determining Execution Order</a></li>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#raexecutiondescriptor">7.3.2. <code class="docutils literal notranslate"><span class="pre">RaExecutionDescriptor</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#query-step-translation">7.3.3. Query Step Translation</a></li>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#query-step-execution">7.3.4. Query Step Execution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="scheduler.html#scalar-subqueries">7.3.4.1. Scalar Subqueries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="codegen.html">7.4. Code Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="codegen.html#query-templates">7.4.1. Query Templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="codegen.html#codegenerator">7.4.2. <code class="docutils literal notranslate"><span class="pre">CodeGenerator</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="codegen.html#runtime-functions-and-extension-functions">7.4.3. Runtime Functions and Extension Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="codegen.html#llvm-optimization-passes">7.4.4. LLVM Optimization Passes</a></li>
<li class="toctree-l3"><a class="reference internal" href="codegen.html#native-codegen">7.4.5. Native Codegen</a><ul>
<li class="toctree-l4"><a class="reference internal" href="codegen.html#cpu-native-code-generation">7.4.5.1. CPU Native Code Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="codegen.html#gpu-native-code-generation">7.4.5.2. GPU Native Code Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="codegen.html#code-cache">7.4.5.3. Code Cache</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kernels.html">7.5. Execution Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="kernels.html#query-fragment-descriptor">7.5.1. Query Fragment Descriptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="kernels.html#dispatch-fragments">7.5.2. Dispatch Fragments</a></li>
<li class="toctree-l3"><a class="reference internal" href="kernels.html#query-execution-context">7.5.3. Query Execution Context</a><ul>
<li class="toctree-l4"><a class="reference internal" href="kernels.html#cpu-execution">7.5.3.1. CPU execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="kernels.html#gpu-execution">7.5.3.2. GPU execution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7.6. Query Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#result-set-storage">7.6.1. Result Set Storage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#logical-targets-and-physical-slots">7.6.1.1. Logical Targets and Physical Slots</a></li>
<li class="toctree-l4"><a class="reference internal" href="#storage-memory-layouts">7.6.1.2. Storage Memory Layouts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#group-by-queries">7.6.1.3. Group by Queries</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reductions">7.6.2. Reductions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessors-and-iterators">7.6.3. Accessors and Iterators</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://doxygen.omnisci.com">Doxygen</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/omnisci/omniscidb">GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/index.html">Glossary of Terms</a></li>
</ul>
<p class="caption"><span class="caption-text">Detailed Class Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/logger.html">Logger</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/logger.html#program-options">Program Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/logger.html#initialization-and-global-instances">Initialization and Global Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/logger.html#usage">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#severity">Severity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#log-files">Log Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#format">Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#channel">Channel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#macros">Macros</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#log">LOG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#check">CHECK</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#stdlog">STDLOG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#debug-timer">DEBUG_TIMER</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/query_state.html">QueryState</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/query_state.html#classes">Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/query_state.html#example-usage">Example Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/query_state.html#summary">Summary</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OmniSciDB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">7. Query Execution</a> &raquo;</li>
        
      <li>7.6. Query Results</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/execution/results.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="query-results">
<h1>7.6. Query Results<a class="headerlink" href="#query-results" title="Permalink to this headline">¶</a></h1>
<p>The final step of query execution is results processing. The query engine drives all result set processing through the <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> class. The <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> class includes method for results reduction, iteration, lazy fetch and string dictionary lookups, and serialization (Enterprise Edition only).</p>
<p>As a hardware accelerated (i.e. parallelized) in memory database, several top-level considerations were made in designing the result set data model:</p>
<ol class="arabic simple">
<li><p>Group by queries constitute the most challenging type of query, as the computation within groups is typically high-contention (i.e. requires atomics or locks). To reduce contention, extra intermediate buffers are introduced during execution. Therefore, the result set reduction model needs to be able to efficiently handle reduction over various aggregate functions and on numerous intermediate buffers iteratively.</p></li>
<li><p>Transfer between CPU and GPU should not require transformations (to the extent possible). Because the CPU and GPU memory systems do not share an address space, no indirection is allowed. In other words, all offsets into the output buffer must be relative.</p></li>
<li><p>Since GPU devices are typically memory constrained relative to the compute available, size-efficiency is very important.</p></li>
</ol>
<p>In this section we discuss the underlying data model that is used for handling results in the query engine and how results are processed (e.g. reduction or sort) and accessed.</p>
<div class="section" id="result-set-storage">
<h2>7.6.1. Result Set Storage<a class="headerlink" href="#result-set-storage" title="Permalink to this headline">¶</a></h2>
<p>The output from each device (see <a class="reference internal" href="kernels.html"><span class="doc">Execution Kernels</span></a>) is a <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> object. However, the underlying buffer for each result set is <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code>; device outputs by default have only one attached <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> object. The <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> manages output buffers, stores some metadata about the initialization values and projected targets in the output buffers, and provides most of the low-level driver methods for reductions.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> owns a “flat” buffer stored as a byte stream. This particular choice makes the data transfer highly efficient to/form the GPU devices (using simple memory copy). However, storing the buffer as a byte stream means more helper methods and metadata are required to access specific data in the buffer. The <code class="docutils literal notranslate"><span class="pre">QueryMemoryDescriptor</span></code> (generated during code generation) assists <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> in determining specific buffer layout attributes. For example, the <code class="docutils literal notranslate"><span class="pre">QueryMemoryDescriptor</span></code> encodes output <a class="reference internal" href="../glossary/index.html#term-target"><span class="xref std std-term">target</span></a> information, including the number of targets and the physical size (in the buffer) and logical size (size of the data type) for each target. A copy of some information is also available directly in <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code>. For output targets, we encode type and initialization values in <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> for fast lookups.</p>
<div class="section" id="logical-targets-and-physical-slots">
<h3>7.6.1.1. Logical Targets and Physical Slots<a class="headerlink" href="#logical-targets-and-physical-slots" title="Permalink to this headline">¶</a></h3>
<p>First, we define some terms:</p>
<ul class="simple">
<li><p>A <strong>Slot</strong> is the physical space in the output buffer where the output target data will be written.</p></li>
<li><p><strong>Logical target size</strong> is the size required to store the output data as dictated by the SQL type of the output. For example, a projected target with SQL type <cite>Double</cite> would have a logical size of 8 Bytes.</p></li>
<li><p><strong>Physical slot size</strong> is the size of the space in the output buffer for the target. The physical size must be <em>at least</em> equal to the logical size.</p></li>
</ul>
<p>Consider the following SQL query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">test</span> <span class="p">(</span><span class="n">x</span> <span class="nb">SMALLINT</span><span class="p">,</span> <span class="n">y</span> <span class="nb">FLOAT</span><span class="p">);</span>

<span class="k">SELECT</span> <span class="n">x</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">AVG</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">test</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">x</span><span class="p">;</span>
</pre></div>
</div>
<p>The following table contains one possible output buffer layout, described using the physical and logical sizes for the outputs.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Target</p></th>
<th class="head"><p>Logical Size</p></th>
<th class="head"><p>Physical Size</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">x</span></code></p></td>
<td><p>2 bytes</p></td>
<td><p>8 bytes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">COUNT(*)</span></code></p></td>
<td><p>4 bytes</p></td>
<td><p>8 bytes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">AVG(y)</span></code></p></td>
<td><p>8 bytes</p></td>
<td><p>8 bytes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">AVG(y)</span></code></p></td>
<td><p>8 bytes</p></td>
<td><p>8 bytes</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>OmniSciDB will attempt to allocate the most compact output buffer possible. In the above example, the 8 byte slots required for <code class="docutils literal notranslate"><span class="pre">AVG</span></code> are forcing 8 byte physical size for all outputs.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">COUNT</span></code> targets each require one slot in the output buffer and a physical size greater than our equal to their logical size. The <code class="docutils literal notranslate"><span class="pre">AVG</span></code> target requires two slots; one to compute the count, and one to compute a running sum. This allows <code class="docutils literal notranslate"><span class="pre">AVG</span></code> to be computed in parallel and reduced across multiple outputs.</p>
<p>Other target types may also require multiple slots. For example. variable length columns (fixed length arrays, variable length arrays, and none-encoded strings) require multiple slots.
.</p>
</div>
<div class="section" id="storage-memory-layouts">
<h3>7.6.1.2. Storage Memory Layouts<a class="headerlink" href="#storage-memory-layouts" title="Permalink to this headline">¶</a></h3>
<p>OmniSciDB is a columnar database, meaning all inputs to the system are columns. However, output results can be stored in either <cite>columnar</cite> or <cite>row-wise</cite> order. The figure below depicts a simplified schematic representation of these two memory layouts using a hypothetical
group by query with <cite>n</cite> group keys and <cite>m</cite> aggregates.</p>
<ul class="simple">
<li><p>In the <strong>row-wise layout</strong>, all physical slots belonging to the same row are consecutive in the memory.</p></li>
<li><p>In the <strong>columnar layout</strong>, all the results for all returned rows are consecutive in memory for each physical slot.</p></li>
</ul>
<img alt="../_images/memory_layout_schematic.png" src="../_images/memory_layout_schematic.png" />
<p>Depending on the type of query, it is common to dedicate some extra portion of the storage buffer to store other related information.
For example, for projection queries we store the offset of the current row within each fragment. This information is later used for <cite>lazy fetch</cite> evaluation of targets that did not require computation (i.e. were not embedded in expressions) but were projected as part of the query.</p>
</div>
<div class="section" id="group-by-queries">
<h3>7.6.1.3. Group by Queries<a class="headerlink" href="#group-by-queries" title="Permalink to this headline">¶</a></h3>
<p>OmniSciDB supports two hash table layouts for group by queries: the <strong>baseline</strong> hash layout and the <strong>perfect</strong> hash layout. For perfect hash, the whole storage buffer is divided into indexed portions such that each portion can be accessed by one and only one set of keys. For a set of keys in a group by query, all possible indices can be upperbounded by the cross-product of each key’s range (i.e., maximum subtracted by minimum). More specifically, for a set of grouped keys <span class="math notranslate nohighlight">\(k_0, \dots, k_n\)</span>, each with maximum values of <span class="math notranslate nohighlight">\(M_0, \dots, M_n\)</span> and minimum values of <span class="math notranslate nohighlight">\(m_0, \dots, m_n\)</span> respectively,
we can compute the unique index as: <span class="math notranslate nohighlight">\((k_0 - m_0) + (M_0 - m_0)(k_1 - m_1) + \dots + (M_0 - m_0) \dots (M_{n-1}-m_{n-1})(k_n - m_n)\)</span></p>
<p>Some indices may end up being unused as there may never be such combination of keys in the input data. However, since there exists an exclusive set of physical slots for each possible outcome, it turns out to be considerably efficient. The total size of the storage for these cases can be exactly computed by having the meta-data for each
input column (e.g., having minimum and maximum of each column). If the memory layout is row-wise then all physical slots belonging to one index (equivalently belonging to a set of keys)
are next to each other in memory. If the memory layout is columnar, after computing the unique index each particular slot can be exactly located by starting from the beginning offset of each column and moving forward until reaching the particular index in mind.</p>
<p>Unfortunately, it is not possible to use such strategy for all group by queries, because the key ranges will eventually grow to exceed the available memory of the device. In such cases, we use the <cite>baseline hash</cite> layout, an open-addressing hash table (using the <cite>Murmur hash function</cite>) with linear probing and a 50% fill rate. If row-wise memory layout is used, we compute the slot in the output buffer as the output of the hash function over the set of grouped keys. If the output slot is already used, we incrementally increase the index until finding an unused one. For columnar output, once the index is computed, we locate separated portions of storage belonging to each slot (by starting from each column’s global offset in the output buffer.</p>
<p>It is important to realize that the storage buffer is structurally the same regardless of the group by query type. The difference is only in the way we assign a set of group keys to those available indexed slots in the storage; for one case the assignment is unique, for the other the assignment is randomly chosen.</p>
</div>
</div>
<div class="section" id="reductions">
<h2>7.6.2. Reductions<a class="headerlink" href="#reductions" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> and <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> classes include methods for aggregating multiple <code class="docutils literal notranslate"><span class="pre">ResultSets</span></code> (by aggregating their respective underlying storage). We refer to this process as <cite>Reduction</cite>. There are three types of reduction currently supported:</p>
<ul class="simple">
<li><p><strong>Append</strong>: For projection queries, it is sufficient to append <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> from one <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> to the other.</p></li>
<li><p><strong>Non-grouped Aggregate</strong>: A <cite>non-grouped aggregate</cite> query is an aggregate without a group by (e.g. <cite>SELECT COUNT(*) from t</cite>). Because there is no key, the reduction step reduces all results into a single row.</p></li>
<li><p><strong>Group By</strong>: All <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> objects are assumed to have the same buffer layout. Therefore, the buffer is walked and each row is reduced into the row from another <code class="docutils literal notranslate"><span class="pre">ResultSetStorage</span></code> object by accumulating each aggregate target. The accumulation step uses the same aggregate function as the <a class="reference internal" href="../glossary/index.html#term-kernel"><span class="xref std std-term">kernel</span></a> used to compute the value in the output buffer.</p></li>
</ul>
<p>Globally, the system reduces each output <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> from a kernel into a parent <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> sequentially. The actual reduction step is parallelized over the rows in the output buffer (except in the case of projections, where the append simply moves a smart pointer and does not involve physically copying or accessing large regions of memory).</p>
</div>
<div class="section" id="accessors-and-iterators">
<h2>7.6.3. Accessors and Iterators<a class="headerlink" href="#accessors-and-iterators" title="Permalink to this headline">¶</a></h2>
<p>The <cite>ResultSet</cite> class provides an iterator method to walk the query output, as well as methods to access results directly at a specified row index. The iterator / accessor methods often require both knowledge of the output layout and knowledge of the target stored in the output slot. For example, the <code class="docutils literal notranslate"><span class="pre">AVG</span></code> aggregate function requires two output slots; one to compute a running count, and one to compute a running sum. During buffer iteration, the actual average value is computed by accessing the values from each slot and dividing. Similar processes are required to decode dictionary encoded strings.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../glossary/index.html" class="btn btn-neutral float-right" title="Glossary of Terms" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="kernels.html" class="btn btn-neutral float-left" title="7.5. Execution Kernels" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, OmniSci, Inc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>