

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.4. Code Generation &mdash; OmniSciDB  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.webp"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/segment_analytics.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7.5. Execution Kernels" href="kernels.html" />
    <link rel="prev" title="7.3. DAG Execution / Translation" href="scheduler.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OmniSciDB
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">System Architecture</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">1. OmniSciDB at 30,000 Feet</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#high-level-diagram">1.1. High Level Diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#data-model">1.2. Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#data-flow">1.3. Data Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#query-execution">1.4. Query Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/index.html#simple-execution-model">1.5. Simple Execution Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/getting_started.html">2. Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/deps.html">2.1. Server Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#prebuilt-dependencies">2.1.1. Prebuilt Dependencies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/deps.html#environment-variables">2.1.1.1. Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-ubuntu">2.1.2. Building on Ubuntu</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/deps.html#ubuntu-16-04">2.1.2.1. Ubuntu 16.04</a></li>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/deps.html#ubuntu-18-04">2.1.2.2. Ubuntu 18.04</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-centos">2.1.3. Building on CentOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-macos">2.1.4. Building on macOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/deps.html#building-on-arch-linux">2.1.5. Building on Arch Linux</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/build.html">2.2. Build OmniSciDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/start.html">2.3. Start and Load Sample Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/start.html#starting-the-server">2.3.1. Starting the Server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../quickstart/start.html#starting-manually">2.3.1.1. Starting Manually</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../quickstart/start.html#working-with-data">2.3.2. Working With Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../catalog/index.html">3. Catalog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#high-level-overview">3.1. High Level Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#system-catalog-global">3.2. System Catalog (Global)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#users">3.2.1. Users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#roles">3.2.2. Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#databases">3.2.3. Databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#permissions">3.2.4. Permissions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#catalog-database-specific">3.3. Catalog (Database Specific)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#tables">3.3.1. Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#columns">3.3.2. Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#dictionaries">3.3.3. Dictionaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#sharded-tables">3.3.4. Sharded Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#views">3.3.5. Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="../catalog/index.html#dashboards">3.3.6. Dashboards</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../catalog/index.html#migration">3.4. Migration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data_model/index.html">4. Data Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../data_model/columnar_layout.html">4.1. Columnar Data Organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/columnar_layout.html#columns">4.1.1. Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/columnar_layout.html#fragments">4.1.2. Fragments</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/columnar_layout.html#chunks">4.1.3. Chunks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../data_model/columnar_layout.html#example-for-chunk-physical-representations">4.1.3.1. Example for chunk physical representations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../data_model/columnar_layout.html#chunkkey">4.1.3.2. ChunkKey</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/physical_layout.html">4.2. Physical Data Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/physical_layout.html#directory-structure">4.2.1. Directory Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../data_model/physical_layout.html#epoch">4.2.1.1. Epoch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/physical_layout.html#data-multipages">4.2.2. Data Multipages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../data_model/physical_layout.html#example-data-page">4.2.2.1. Example Data Page:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/physical_layout.html#metadata-pages">4.2.3. Metadata Pages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/memory_layout.html">4.3. Memory  Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/api.html">4.4. External API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/api.html#design">4.4.1. Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/api.html#protocols">4.4.2. Protocols</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data_model/types.html">4.5. Data Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data_model/types.html#scalar-types">4.5.1. Scalar Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/types.html#scalar-types-with-encoding">4.5.2. Scalar Types with Encoding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data_model/types.html#variable-length-types">4.5.3. Variable Length Types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../flow/data.html">5. Data Flow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../flow/data.html#input-data">5.1. Input Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flow/data.html#output-data">5.2. Output Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../calcite/calcite_parser.html">6. Calcite Parser</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. Query Execution</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">7.1. Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="overview.html#request-handler-mapdhandler">7.1.1. Request Handler (MapDHandler)</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#apache-calcite">7.1.2. Apache Calcite</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#relational-algebra-executor">7.1.3. Relational Algebra Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#relational-algebra-abstract-interpreter-and-optimizer">7.1.4. Relational Algebra Abstract Interpreter and Optimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#relational-algebra-translator">7.1.5. Relational Algebra Translator</a></li>
<li class="toctree-l3"><a class="reference internal" href="overview.html#executor">7.1.6. Executor</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="optimizer.html">7.2. Interpreter / Optimizer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="optimizer.html#interpreter">7.2.1. Interpreter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#relalgnode">7.2.1.1. <code class="docutils literal notranslate"><span class="pre">RelAlgNode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#rex">7.2.1.2. <code class="docutils literal notranslate"><span class="pre">Rex</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="optimizer.html#omniscidb-specific-query-optimization">7.2.2. OmniSciDB Specific Query Optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#mark-noops">7.2.2.1. Mark Noops</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#eliminate-identical-copies">7.2.2.2. Eliminate Identical Copies</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#fold-filters">7.2.2.3. Fold Filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#eliminate-dead-columns">7.2.2.4. Eliminate Dead Columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#separate-window-function-expressions">7.2.2.5. Separate Window Function Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#coalesce-nodes">7.2.2.6. Coalesce Nodes</a></li>
<li class="toctree-l4"><a class="reference internal" href="optimizer.html#create-left-deep-join">7.2.2.7. Create Left Deep Join</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="scheduler.html">7.3. DAG Execution / Translation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#determining-execution-order">7.3.1. Determining Execution Order</a></li>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#raexecutiondescriptor">7.3.2. <code class="docutils literal notranslate"><span class="pre">RaExecutionDescriptor</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#query-step-translation">7.3.3. Query Step Translation</a></li>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html#query-step-execution">7.3.4. Query Step Execution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="scheduler.html#scalar-subqueries">7.3.4.1. Scalar Subqueries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7.4. Code Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#query-templates">7.4.1. Query Templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#codegenerator">7.4.2. <code class="docutils literal notranslate"><span class="pre">CodeGenerator</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#runtime-functions-and-extension-functions">7.4.3. Runtime Functions and Extension Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#llvm-optimization-passes">7.4.4. LLVM Optimization Passes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#native-codegen">7.4.5. Native Codegen</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cpu-native-code-generation">7.4.5.1. CPU Native Code Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gpu-native-code-generation">7.4.5.2. GPU Native Code Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-cache">7.4.5.3. Code Cache</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kernels.html">7.5. Execution Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="kernels.html#query-fragment-descriptor">7.5.1. Query Fragment Descriptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="kernels.html#dispatch-fragments">7.5.2. Dispatch Fragments</a></li>
<li class="toctree-l3"><a class="reference internal" href="kernels.html#query-execution-context">7.5.3. Query Execution Context</a><ul>
<li class="toctree-l4"><a class="reference internal" href="kernels.html#cpu-execution">7.5.3.1. CPU execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="kernels.html#gpu-execution">7.5.3.2. GPU execution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="results.html">7.6. Query Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="results.html#result-set-storage">7.6.1. Result Set Storage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="results.html#logical-targets-and-physical-slots">7.6.1.1. Logical Targets and Physical Slots</a></li>
<li class="toctree-l4"><a class="reference internal" href="results.html#storage-memory-layouts">7.6.1.2. Storage Memory Layouts</a></li>
<li class="toctree-l4"><a class="reference internal" href="results.html#group-by-queries">7.6.1.3. Group by Queries</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="results.html#reductions">7.6.2. Reductions</a></li>
<li class="toctree-l3"><a class="reference internal" href="results.html#accessors-and-iterators">7.6.3. Accessors and Iterators</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://doxygen.omnisci.com">Doxygen</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/omnisci/omniscidb">GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/index.html">Glossary of Terms</a></li>
</ul>
<p class="caption"><span class="caption-text">Detailed Class Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/logger.html">Logger</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/logger.html#program-options">Program Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/logger.html#initialization-and-global-instances">Initialization and Global Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/logger.html#usage">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#severity">Severity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#log-files">Log Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#format">Format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#channel">Channel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components/logger.html#macros">Macros</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#log">LOG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#check">CHECK</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#stdlog">STDLOG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/logger.html#debug-timer">DEBUG_TIMER</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/query_state.html">QueryState</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/query_state.html#classes">Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/query_state.html#example-usage">Example Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/query_state.html#summary">Summary</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OmniSciDB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">7. Query Execution</a> &raquo;</li>
        
      <li>7.4. Code Generation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/execution/codegen.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="code-generation">
<h1>7.4. Code Generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h1>
<p>OmniSciDB generates native code using the <a class="reference external" href="http://llvm.org">LLVM</a> library. Code generation primarily makes calls into the <cite>LLVM IR Builder</cite> to build up LLVM IR according to the provided AST (see <a class="reference internal" href="scheduler.html"><span class="doc">DAG Execution / Translation</span></a>).</p>
<p>Code generation for a query is managed by the <code class="docutils literal notranslate"><span class="pre">Executor</span></code> object assigned to the query. Code generation state is stored within the <code class="docutils literal notranslate"><span class="pre">QueryCompilationDescriptor</span></code>. The compilation descriptor also initiates code generation via its <code class="docutils literal notranslate"><span class="pre">compile</span></code> method.</p>
<p>The outer-most function for a <a class="reference internal" href="../glossary/index.html#term-kernel"><span class="xref std std-term">kernel</span></a> is pre-defined in <code class="docutils literal notranslate"><span class="pre">RuntimeFunctions.cpp</span></code>. The generated code typically consists of two functions; the <code class="docutils literal notranslate"><span class="pre">query_func</span></code> and the <code class="docutils literal notranslate"><span class="pre">row_func</span></code>. The <code class="docutils literal notranslate"><span class="pre">query_func</span></code> loops over all input rows, while the <code class="docutils literal notranslate"><span class="pre">row_func</span></code> contains most of the logic for processing inputs, running expressions, and writing outputs.</p>
<div class="section" id="query-templates">
<h2>7.4.1. Query Templates<a class="headerlink" href="#query-templates" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">query_func</span></code> is built and then bound to a query function template depending on query execution dispatch mode (see <a class="reference internal" href="kernels.html"><span class="doc">Execution Kernels</span></a> for more on kernel execution modes). Query templates, specified in <code class="docutils literal notranslate"><span class="pre">RuntimeFunctions.cpp</span></code>, provide the top-level kernel function declaration and basic logic (i.e. iterate over input fragments for a <cite>multi-fragment kernel</cite>). The <code class="docutils literal notranslate"><span class="pre">query_func</span></code> is bound to the <code class="docutils literal notranslate"><span class="pre">query_stub</span></code> function, replacing its default implementation in the first step of code generation.</p>
</div>
<div class="section" id="codegenerator">
<h2>7.4.2. <code class="docutils literal notranslate"><span class="pre">CodeGenerator</span></code><a class="headerlink" href="#codegenerator" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">CodeGenerator</span></code> converts analyzer expressions into <cite>LLVM IR</cite>. The <code class="docutils literal notranslate"><span class="pre">CodeGenerator</span></code> constructor takes the code generation state and query plan state from the <code class="docutils literal notranslate"><span class="pre">Executor</span></code> and makes calls into the <cite>LLVM IR Builder</cite>, using the context and module attached to the code generation state.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ScalarCodeGenerator</span></code> is derived from the <code class="docutils literal notranslate"><span class="pre">CodeGenerator</span></code> for unit testing. With the <code class="docutils literal notranslate"><span class="pre">ScalarCodeGenerator</span></code>, the dependency on the executor is removed, and native code for either the CPU or GPU can be generated for most analyzer expressions.</p>
</div>
<div class="section" id="runtime-functions-and-extension-functions">
<h2>7.4.3. Runtime Functions and Extension Functions<a class="headerlink" href="#runtime-functions-and-extension-functions" title="Permalink to this headline">¶</a></h2>
<p>All query kernels are generated from LLVM IR using the <code class="docutils literal notranslate"><span class="pre">CodeGenerator</span></code>. However, for certain helper functions it is more convenient to implement required functionality in C. For example, the aggregate function for computing <cite>SUM</cite> of a not null column requires null sentinel awareness to ensure <cite>null</cite> values of the argument type are not accidentally added to the running value. The 32-bit integer implementation of this function is shown below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="n">ALWAYS_INLINE</span> <span class="kt">int32_t</span> <span class="n">agg_sum_int32_skip_val</span><span class="p">(</span><span class="kt">int32_t</span><span class="o">*</span> <span class="n">agg</span><span class="p">,</span>
                                                        <span class="k">const</span> <span class="kt">int32_t</span> <span class="n">val</span><span class="p">,</span>
                                                        <span class="k">const</span> <span class="kt">int32_t</span> <span class="n">skip_val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">old</span> <span class="o">=</span> <span class="o">*</span><span class="n">agg</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">skip_val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">skip_val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">agg_sum_int32</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">agg</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">old</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>System functions like the example above are referred to as <cite>Runtime Functions</cite>. SQL functions are stored in a separate file and are referred to as <cite>Extension Functions</cite>. The extension functions are automatically registered with Calcite at startup, where runtime functions are helpers functions meant for use by the <a class="reference internal" href="../glossary/index.html#term-kernel"><span class="xref std std-term">kernel</span></a>.</p>
<p>The <cite>ALWAYS_INLINE</cite> decorator tells the LLVM compiler to inline the runtime functions, so the net effect is the same as generating the function using the LLVM IR Builder.</p>
</div>
<div class="section" id="llvm-optimization-passes">
<h2>7.4.4. LLVM Optimization Passes<a class="headerlink" href="#llvm-optimization-passes" title="Permalink to this headline">¶</a></h2>
<p>Optimization of generated code is primarily managed by the LLVM Pass Manager. The <code class="docutils literal notranslate"><span class="pre">optimize_ir</span></code> free function runs multiple LLVM passes over the IR (e.g. <cite>instruction combining</cite>, <cite>instruction simplification</cite>, etc). By using the pass manager, OmniSciDB can chose LLVM passes which will maximize query performance based on both query parameters and the target device for which code is being compiled.</p>
<p>OmniSciDB also includes a custom function for eliminating dead recursive function calls. Because OmniSciDB supplies runtime functions and extension functions in <cite>C++</cite>, functions can be pulled into the module which are not being called by the primary kernel function. These functions can be quickly pruned to prevent compiling all the runtime and extension functions with each query.</p>
</div>
<div class="section" id="native-codegen">
<h2>7.4.5. Native Codegen<a class="headerlink" href="#native-codegen" title="Permalink to this headline">¶</a></h2>
<p>Once the complete set of <cite>LLVM IR</cite> has been assembled for a query, generation of machine code can begin. OmniSciDB refers to machine code as <cite>native code</cite> (i.e. native machine code for a particular device). Below we describe <cite>CPU Native Code Generation</cite> and <cite>GPU Native Code Generation</cite>.</p>
<div class="section" id="cpu-native-code-generation">
<h3>7.4.5.1. CPU Native Code Generation<a class="headerlink" href="#cpu-native-code-generation" title="Permalink to this headline">¶</a></h3>
<p>CPU code generation uses the <a class="reference external" href="https://llvm.org/docs/MCJITDesignAndImplementation.html">LLVM MCJIT</a> to generate native code for the CPU. The code generator performs the following steps when generating native CPU code:</p>
<ol class="arabic simple">
<li><p>Optimizes input IR using the techniques described above.</p></li>
<li><p>Initializes the LLVM MCJIT Backend.</p></li>
<li><p>Takes ownership of the LLVM Module.</p></li>
<li><p>Creates a <code class="docutils literal notranslate"><span class="pre">LLVM::ExecutionBuilder</span></code> object wrapped in an <code class="docutils literal notranslate"><span class="pre">ExecutionEngine</span></code> object responsible for JIT runtime code generation.</p></li>
<li><p>Generates native code by calling <code class="docutils literal notranslate"><span class="pre">finalizeObject()</span></code> on the <code class="docutils literal notranslate"><span class="pre">ExecutionEngine</span></code>.</p></li>
</ol>
<p>Native code generated for CPU can be called by getting the function pointer from the execution engine and calling the function.</p>
</div>
<div class="section" id="gpu-native-code-generation">
<h3>7.4.5.2. GPU Native Code Generation<a class="headerlink" href="#gpu-native-code-generation" title="Permalink to this headline">¶</a></h3>
<p>GPU code generation uses LLVM to generate <a class="reference external" href="https://docs.nvidia.com/cuda/parallel-thread-execution/index.html">nVidia PTX</a> and then converts the PTX to machine code using the nVidia CUDA driver API. The following intermediate steps are performed during this process:</p>
<ol class="arabic simple">
<li><p>Updates LLVM Module target details to target nVidia GPU</p></li>
<li><p>Optimizes input IR using the techniques described above.</p></li>
<li><p>Generates PTX using the LLVM Pass Manager.</p></li>
<li><p>Converts the PTX to a <cite>cubin</cite> binary machine code file using the nVidia CUDA driver API.</p></li>
<li><p>Copies the <cite>cubin</cite> binary to the relevant GPUs (typically all available GPUs)</p></li>
<li><p>Stores a function pointer to the copied binary in GPU memory, to be passed to the nVidia CUDA driver API for kernel launch.</p></li>
</ol>
</div>
<div class="section" id="code-cache">
<h3>7.4.5.3. Code Cache<a class="headerlink" href="#code-cache" title="Permalink to this headline">¶</a></h3>
<p>Both CPU and GPU generated code is cached in a code cache per query. The cache uses a LRU eviction mechanism to ensure large numbers of queries do not fill up CPU or GPU memory. The <cite>key</cite> for the code cache is the serialized LLVM representation of the <code class="docutils literal notranslate"><span class="pre">query_func</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="kernels.html" class="btn btn-neutral float-right" title="7.5. Execution Kernels" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="scheduler.html" class="btn btn-neutral float-left" title="7.3. DAG Execution / Translation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, OmniSci, Inc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>